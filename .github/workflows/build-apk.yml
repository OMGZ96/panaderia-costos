
name: Build Android APK

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [ created, published ]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build APK
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Clear Gradle cache
      run: |
        rm -rf ~/.gradle/caches
        rm -rf ~/.gradle/wrapper
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Clear npm cache
      run: npm cache clean --force
    
    - name: Install dependencies
      run: |
        rm -rf node_modules
        rm -f package-lock.json
        npm install --legacy-peer-deps
    
    - name: Build web application
      run: npm run build
      env:
        VITE_GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
    
    - name: Update version code
      run: |
        TIMESTAMP=$(date +%s)
        VERSION_CODE=$((TIMESTAMP / 1000))
        echo "VERSION_CODE=$VERSION_CODE" >> $GITHUB_ENV
        echo "Updated version code to: $VERSION_CODE"
    
    - name: Sync Capacitor with Android
      run: |
        if [ -d "android" ]; then
          echo "Android platform exists, syncing..."
          npx capacitor sync android
        else
          echo "Adding Android platform..."
          npx capacitor add android
        fi
    
    - name: Update Android build.gradle with new version
      run: |
        cd android/app
        sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/g" build.gradle
        cat build.gradle | grep versionCode
    
    - name: Build APK (Debug)
      working-directory: android
      run: |
        chmod +x gradlew
        ./gradlew clean assembleDebug --no-daemon -Dorg.gradle.jvmargs="-Xmx2048m"
      continue-on-error: false
    
    - name: List generated APK files
      run: |
        echo "=== Generated APK Files ==="
        find android -type f -name "*.apk" -exec ls -lh {} \;
      continue-on-error: true
    
    
    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: panaderia-costos-debug
        path: android/app/build/outputs/apk/debug/
        retention-days: 30
        if-no-files-found: warn
    
    - name: Decode Keystore
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release-key.jks

    - name: Build APK (Release) - On Tag
      if: startsWith(github.ref, 'refs/tags/')
      working-directory: android
      run: |
        chmod +x gradlew
        ./gradlew clean assembleRelease --no-daemon
      env:
        SIGNING_STORE_FILE: release-key.jks
        SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      continue-on-error: true
    
    - name: Upload Release APK
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-artifact@v4
      with:
        name: panaderia-costos-release
        path: android/app/build/outputs/apk/release/
        retention-days: 90
        if-no-files-found: warn
    
    - name: Create GitHub Release with APK
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          android/app/build/outputs/apk/release/*.apk
          android/app/build/outputs/apk/debug/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
